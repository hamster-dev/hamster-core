# this builds the Dockerfile twice, for app and worker.  stupid  FIXME?
version: '2'
services:
    db:
      image: "postgres:latest"
      expose:
        - 5432
    # The web and app servers both share the same codebase;
    # when app.sh is run for the app container, it generates the static
    # files that are used by web container.  #TODO fix this, maybe?
    redis:
      image: "redis:latest"
      expose:
        - 6379
    web:
      image: "nginx:latest"
      ports:
        - "8080:8080"
      links:
        - app
      volumes:
        - ./nginx.conf:/etc/nginx/conf.d/default.conf
        # below host path contain files generated by app container.
        # it's a bit race-y, but whatever.
        # error with modern docker:
        # ERROR: create hamster/static: "hamster/static" includes invalid characters for a local volume name, only "[a-zA-Z0-9][a-zA-Z0-9_.-]" are allowed
        #- hamster/static:/usr/local/nginx/html/static
    app:
      build:
        context: .
        args:
          - http_proxy
          - https_proxy
      command: ./app.sh
      environment:
        - HAMSTER_GITHUB_API_TOKEN
        - HAMSTER_GITHUB_API_USERNAME
        - HAMSTER_GITHUB_HOST
        - HAMSTER_JENKINS_API_USERNAME
        - HAMSTER_JENKINS_API_TOKEN
        - DJANGO_SETTINGS_MODULE=hamster.settings
        - NUM_WORKERS=6
        - NO_PROXY
        - no_proxy
      volumes:
        - .:/hamster
      expose:
        - "8000"
      links:
        - db
        - redis
    worker:
      build:
        context: .
        args:
          - http_proxy
          - https_proxy
      command: ./worker.sh
      environment:
        - HAMSTER_GITHUB_API_TOKEN
        - HAMSTER_GITHUB_API_USERNAME
        - HAMSTER_GITHUB_HOST
        - HAMSTER_JENKINS_API_USERNAME
        - HAMSTER_JENKINS_API_TOKEN
        - DJANGO_SETTINGS_MODULE=hamster.settings
        - NUM_WORKERS=4
        - NO_PROXY
        - no_proxy
      volumes:
        - .:/hamster
      links:
        - db
        - redis
